//
//  GameField.m
//  CocoaGameOfLife
//
//  Created by vileda on 22.03.09.
//  Copyright 2009 Tristan Leo. All rights reserved.
//

#import "GameField.h"

@implementation GameField

@synthesize height;
@synthesize width;
@synthesize cells;

- (id)initWithFrame:(NSRect)frame {
    self = [super initWithFrame:frame];
    if (self) {
		width = 160;
		height = 160;
		cellSize = 2;
		generation = 0;
		cells = [[NSMutableArray alloc] initWithCapacity:width];
		
		for (int i = 0; i < width; i++) {
			NSMutableArray *row = [NSMutableArray arrayWithCapacity:height];
			for (int j = 0; j < height; j++) {
				[row insertObject:[[Cell alloc] init] atIndex: j];
			}
			[cells insertObject:row atIndex:i];
		}
    }
    return self;
}

- (void)drawRect:(NSRect)rect
{
	[[NSColor whiteColor] set];
	NSRectFill(rect);
	
	for (int i = 0; i < width; i++) {
		for (int j = 0; j < height; j++) {
			Cell* cell = [self cellAtColumn:i andRow:j];
			NSRect cellRect = NSMakeRect(i*cellSize, j*cellSize, cellSize, cellSize);
			[[NSColor blueColor] set];
			if(cell.alive)
				NSRectFill(cellRect);
		}
	}
}

- (void)updateCells
{
	NSMutableArray *nextGen = [[NSMutableArray alloc] initWithCapacity:width];
	
	for (int i = 0; i < width; i++) {
		NSMutableArray *row = [NSMutableArray arrayWithCapacity:height];
		for (int j = 0; j < height; j++) {
			int n = [self findNeighboursForCellAtColumn:i andRow:j];
			Cell *cell = [self cellAtColumn:i andRow:j];
			Cell *nextCell = [[Cell alloc] init];
			if((n == 2) && [cell alive]) {
                // Cells that are alive, with 2 neighbours stay alive
                [nextCell setAlive:YES];
            }
            else if(n == 3) {
                // Cells that have 3 neighbours are alive
                [nextCell setAlive:YES];
            }
            else {
                // Everyone else dies
                [nextCell setAlive:NO];
            }
			[row insertObject:nextCell atIndex: j];
		}
		[nextGen insertObject:row atIndex:i];
	}
	[self setCells:nextGen];
	generation++;
	[generationField setIntValue:generation];
	[self setNeedsDisplay:YES];
}

- (IBAction)play:(id)sender
{
    if(updateTimer == nil) {
        [play setTitle:@"Stop"];
        updateTimer = [NSTimer scheduledTimerWithTimeInterval:0.000001
                                                       target:self
                                                     selector:@selector(timerFired:)
                                                     userInfo:nil
                                                      repeats:YES];
    }
    else {
        [play setTitle:@"Start"];
        [updateTimer invalidate];
        updateTimer = nil;
    }
}

- (IBAction)tick:(id)sender
{
	[self updateCells];
}

- (void)timerFired:(id)sender
{
    [self updateCells];
}

- (int)findNeighboursForCellAtColumn:(int)colKey andRow:(int)rowKey
{
    int total = 0;
	
    // Row Above
    if([self cellAliveAtColumn:(colKey - 1) andRow:(rowKey + 1)])
        total++;
    if([self cellAliveAtColumn:colKey andRow:(rowKey + 1)])
        total++;
    if([self cellAliveAtColumn:(colKey + 1) andRow:(rowKey + 1)])
        total++;
	
    // Left & Right
    if([self cellAliveAtColumn:(colKey - 1) andRow:rowKey])
        total++;
    if([self cellAliveAtColumn:(colKey + 1) andRow:rowKey])
        total++;
	
    // Row Below
    if([self cellAliveAtColumn:(colKey - 1) andRow:(rowKey - 1)])
        total++;
    if([self cellAliveAtColumn:colKey andRow:(rowKey - 1)])
        total++;
    if([self cellAliveAtColumn:(colKey + 1) andRow:(rowKey - 1)])
        total++;
	
    return total;
}

- (bool)cellAliveAtColumn:(int)colKey andRow:(int)rowKey
{
    return [[self cellAtColumn:colKey andRow:rowKey] alive];
}

- (Cell *)cellAtColumn:(int)colKey andRow:(int)rowKey
{
    if((colKey < 0 || colKey >= [self width]) || (rowKey < 0 || rowKey >= [self height]))
        return nil;
    return [[cells objectAtIndex:colKey] objectAtIndex:rowKey];
}

- (void)mouseDown:(NSEvent*)theEvent
{
	NSPoint mouseLoc = [self convertPoint:[theEvent locationInWindow] fromView:nil];
	float x = floor(mouseLoc.x/cellSize);
	float y = floor(mouseLoc.y/cellSize);
	
	Cell* cell = (Cell*)[[cells objectAtIndex:x] objectAtIndex:y];
	[cell toggle];

	[self setNeedsDisplay:YES];
}

-(void)setWidth:(int)w
{
	width = w;
	NSSize s;
	s.height = height*cellSize;
	s.width = width*cellSize;
	[self viewWillStartLiveResize];
	[self setFrameSize:s];
	[self viewDidEndLiveResize];
}

-(void)setHeight:(int)h
{
	height = h;
	NSSize s;
	s.height = height*cellSize;
	s.width = width*cellSize;
	[self setFrameSize:s];
	[self setNeedsDisplay:true];
}

@end
